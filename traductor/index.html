<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traductor por Voz</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 50px; transition: background 0.3s, color 0.3s; }
        .dark-mode { background-color: black; color: white; }
        #original, #translated { margin-top: 20px; font-size: 20px; }
        button { padding: 10px 20px; font-size: 18px; cursor: pointer; margin: 10px; }
    </style>
</head>
<body>

    <h1>Traductor por Voz (InglÃ©s - EspaÃ±ol)</h1>
    <button onclick="startRecognition()">ðŸŽ¤ Hablar</button>
    <button onclick="stopRecognition()">âœ‹ Detener</button>
    <button onclick="toggleDarkMode()">ðŸŒ™ Modo Oscuro</button>
    <button onclick="exportHistory()">ðŸ“‚ Exportar Historial</button>
    <p id="original"><strong>Texto original:</strong> </p>
    <p id="translated"><strong>TraducciÃ³n:</strong> </p>
    <br><br>
    <h2>Historial de Traducciones</h2>
    <div id="history"></div>

    <script>
        let recognition;

        function startRecognition() {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'es-ES,en-US'; // Soporta espaÃ±ol e inglÃ©s
            recognition.start();

            recognition.onresult = async (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById("original").innerHTML = `<strong>Texto original:</strong> ${text}`;

                // Detectar idioma con mÃ¡s precisiÃ³n
                const isEnglish = /^[A-Za-z\s]+$/.test(text);
                const targetLang = isEnglish ? 'es' : 'en';

                const translatedText = await translateText(text, targetLang);
                document.getElementById("translated").innerHTML = `<strong>TraducciÃ³n:</strong> ${translatedText}`;

                // Leer la traducciÃ³n en voz alta
                const speech = new SpeechSynthesisUtterance(translatedText);
                speech.lang = targetLang === 'es' ? 'es-ES' : 'en-US';
                window.speechSynthesis.speak(speech);

                saveToHistory(text, translatedText) 

                if (text.toLowerCase() === "activar modo oscuro" || text.toLowerCase() === "desactivar modo oscuro") {
                    toggleDarkMode();
                }else if (text.toLowerCase() === "borrar historial") {
                    localStorage.removeItem("translationHistory");
                    updateHistoryUI();
                }
            };

            recognition.onerror = (event) => {
                console.error("Error de reconocimiento: ", event.error);
            };
        }

        function stopRecognition() {
            if (recognition) {
                recognition.stop();
            }
        }

        async function translateText(text, targetLang) {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
            
            try {
                const response = await fetch(url);
                const result = await response.json();
                return result[0][0][0];
            } catch (error) {
                console.error("Error al traducir:", error);
                return "Error en la traducciÃ³n";
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
        }

        function saveToHistory(original, translated) {
            let history = JSON.parse(localStorage.getItem("translationHistory")) || [];
            history.unshift({ original, translated });
            localStorage.setItem("translationHistory", JSON.stringify(history));
            updateHistoryUI();
        }

        function updateHistoryUI() {
            const historyDiv = document.getElementById("history");
            const history = JSON.parse(localStorage.getItem("translationHistory")) || [];
            historyDiv.innerHTML = history.slice(0, 5).map(entry => 
                `<p><strong>${entry.original}</strong> â†’ ${entry.translated}</p>`).join("");
        }

        function exportHistory() {
            const history = localStorage.getItem("translationHistory") || "[]";
            const blob = new Blob([history], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "historial_traducciones.json";
            a.click();
        }
    </script>

</body>
</html>
